{"version":3,"file":"index.modern.mjs","sources":["../src/cli/index.ts"],"sourcesContent":["#! /usr/bin/env node\n\nimport 'dotenv/config'\nimport { Command } from 'commander'\nimport { buildClient } from '@datocms/cma-client-node'\nimport dedent from 'dedent-js'\nimport { table } from 'table'\nimport prettyBytes from 'pretty-bytes'\n\nconst version = '1.0.0'\nconst program = new Command();\n\nprogram\n  .version(version)\n  .description(`next-dato-utils v${version}`)\n  .option(\"-i, --info\", \"Info DatoCMS project\")\n  .option(\"-u, --usage\", \"Usage DatoCMS project\")\n  .option(\"-to, --token <value>\", \"Api token\")\n  .option(\"-t, --test <value>\", \"Test DatoCMS project\")\n  .parse(process.argv);\n\nconst options = program.opts();\nconst apiToken = options.token ?? process.env.DATOCMS_API_TOKEN\n\nif (!apiToken)\n  throw new Error('DATOCMS_API_TOKEN is required')\n\nconst client = buildClient({\n  apiToken,\n  environment: process.env.DATOCMS_ENVIRONMENT as string || 'main',\n})\n\nif (options.info)\n  info();\nif (options.usage)\n  usage();\n\nasync function info() {\n  const [site, itemTypes, webhooks, plugins, buildTriggers] = await Promise.all([\n    client.site.find(),\n    client.itemTypes.list(),\n    client.webhooks.list(),\n    client.plugins.list(),\n    client.buildTriggers.list(),\n  ])\n\n  const text = dedent(`\n    ${site.name}\n    ${buildTriggers.find(t => t.frontend_url)?.frontend_url ?? 'No frontend url'}\n\n    -------------------------------\n    Timezone: ${site.timezone}\n    Locales: ${site.locales}\n\n    Models\n    -------------------------------\n    ${itemTypes.filter(el => !el.modular_block).map(itemType => itemType.api_key).join('\\n')}\n\n    Blocks\n    -------------------------------\n    ${itemTypes.filter(el => el.modular_block).map(itemType => itemType.api_key).join('\\n')}\n\n    Webhooks\n    -------------------------------\n    ${webhooks.map(webhook => `${webhook.name}\\n${webhook.url}`).join('\\n\\n')}\n\n    Build Triggers\n    -------------------------------\n    ${buildTriggers.map(t => `${t.name}\\n${t.frontend_url}`).join('\\n')}\n\n    Plugins\n    -------------------------------\n    ${plugins.map(plugin => `${plugin.name}`).join('\\n')}\n  `)\n  console.log(text)\n\n}\n\nasync function usage() {\n  const [site, usage] = await Promise.all([client.site.find(), client.dailyUsages.list()])\n\n  const fNumber = (num: number) => !num ? 0 : num.toLocaleString('en-US', { maximumFractionDigits: 0 })\n  const usageLast = usage.filter(el => new Date(el.date).getMonth() < new Date().getMonth())\n  const usageCurrent = usage.filter(el => new Date(el.date).getMonth() === new Date().getMonth())\n  const usageTotal = {\n    last: {\n      days: usageLast.length,\n      cda: usageLast.reduce((acc, el) => acc + el.cda_api_calls + el.cma_api_calls, 0),\n      cma: usageLast.reduce((acc, el) => acc + el.cma_api_calls, 0),\n      bytes: usageLast.reduce((acc, el) => acc + el.assets_traffic_bytes, 0),\n    },\n    current: {\n      days: usageCurrent.length,\n      cda: usageCurrent.reduce((acc, el) => acc + el.cda_api_calls + el.cma_api_calls, 0),\n      cma: usageCurrent.reduce((acc, el) => acc + el.cma_api_calls, 0),\n      bytes: usageCurrent.reduce((acc, el) => acc + el.assets_traffic_bytes, 0),\n    }\n  }\n\n  const usageTable = [\n    ['Date', 'CDA', 'CMA', \"Traffic\"],\n    ...usage.filter(el => new Date(el.date).getMonth() === new Date().getMonth()).map(el => [\n      el.date,\n      fNumber(el.cda_api_calls),\n      fNumber(el.cma_api_calls),\n      prettyBytes(el.assets_traffic_bytes, { maximumFractionDigits: 1 })\n    ])\n  ]\n  const totalTable = [\n    ['Period', 'CDA', 'CDA (avg)', 'CMA', 'CMA (avg)', 'Traffic'],\n    ['Last month', fNumber(usageTotal.last.cda), fNumber(usageTotal.last.cda / usageTotal.last.days), fNumber(usageTotal.last.cma), fNumber(usageTotal.last.cma / usageTotal.last.days), prettyBytes(usageTotal.last.bytes, { maximumFractionDigits: 1 })],\n    ['Current', fNumber(usageTotal.current.cda), fNumber(usageTotal.current.cda / usageTotal.current.days), fNumber(usageTotal.current.cma), fNumber(usageTotal.current.cma / usageTotal.current.days), prettyBytes(usageTotal.current.bytes, { maximumFractionDigits: 1 })]\n  ]\n\n  const text = dedent(`\n    ${site.name}\n    \n    ${table(usageTable, { header: { alignment: 'center', content: 'Usage (CDA / CMA)' } })}\n    ${table(totalTable, { header: { alignment: 'center', content: `${site.name} - Totals` } })}\n\n  `)\n  console.log(text)\n\n}\n"],"names":["_options$token","version","program","Command","description","option","parse","process","argv","options","opts","apiToken","token","env","DATOCMS_API_TOKEN","Error","client","buildClient","environment","DATOCMS_ENVIRONMENT","info","Promise","resolve","all","site","find","itemTypes","list","webhooks","plugins","buildTriggers","then","_ref2","_buildTriggers$find$f","_buildTriggers$find","text","dedent","name","t","frontend_url","timezone","locales","filter","el","modular_block","map","itemType","api_key","join","webhook","url","plugin","console","log","e","reject","usage","dailyUsages","_ref","fNumber","num","toLocaleString","maximumFractionDigits","usageLast","Date","date","getMonth","usageCurrent","usageTotal","last","days","length","cda","reduce","acc","cda_api_calls","cma_api_calls","cma","bytes","assets_traffic_bytes","current","usageTable","concat","prettyBytes","totalTable","table","header","alignment","content"],"mappings":"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"}